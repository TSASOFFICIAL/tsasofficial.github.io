<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Loading...</title>
  <link rel="stylesheet" type="text/css" href="../../style.css">
  <link rel="shortcut icon" type="image/png" href="../../images/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Angkor&family=Belanosima&display=swap" rel="stylesheet">
  <script>
    async function onload() {
      const params = new URLSearchParams(window.location.search);
      const token = params.get("token");
    
      if (!token) {
        alert("You must log in first.");
        window.location.href = "../../";
        return;
      }
    
      try {
        // Validate token with PHP API
        const response = await fetch(`https://dominic.eu5.org/TSAS/validateToken/?token=${encodeURIComponent(token)}`);
        const data = await response.json();
    
        if (!data.valid) {
          alert("Invalid or expired login session. Please log in again.");
          window.location.href = "../../";
          return;
        }
    
        // ✅ Move provider flags here
        const microsoftaccount = params.get("mslogin") === "true";
        const googleaccount = params.get("glogin") === "true";
    
        // Token is valid — make cookies
        const username = data.name;
        let pictureURL = "";
    
        if (data.pictureUrl && data.pictureUrl.trim() !== "") {
          pictureURL = data.pictureUrl;
        } else if (data.image_data && data.image_type) {
          pictureURL = `data:${data.image_type};base64,${data.image_data}`;
        }

        // ✅ NEW: if Microsoft or Google login sends a base64 image, use it directly
        if (data.picture && data.picture.startsWith("data:image")) {
          pictureURL = data.picture;
        }
        
        // Create cookies (1 day)
        const cookieLife = 86400;
        const cookieOptions = "; max-age=" + cookieLife + "; SameSite=None; Secure; path=/";
    
        document.cookie = "username=" + encodeURIComponent(username) + cookieOptions;
        document.cookie = "picture=" + encodeURIComponent(pictureURL) + cookieOptions;
        document.cookie = "usingotheroptions=" + googleaccount + cookieOptions;
        document.cookie = "usingmicrosoftaccount=" + microsoftaccount + cookieOptions;
        document.cookie = "iniframe=false" + cookieOptions;
        document.cookie = "inapp=false" + cookieOptions;
    
        // ✅ Now set provider cookies safely
        if (microsoftaccount) {
          document.cookie = "provider=microsoft" + cookieOptions;
          document.cookie = "socialtoken=" + encodeURIComponent(token) + cookieOptions;
        } else if (googleaccount) {
          document.cookie = "provider=google" + cookieOptions;
          document.cookie = "socialtoken=" + encodeURIComponent(token) + cookieOptions;
        } else {
          document.cookie = "provider=local" + cookieOptions;
        }
    
        // Redirect to members page
        window.location.href = "../";
    
      } catch (err) {
        console.error("Token validation failed:", err);
        alert("Error verifying login. Please try again.");
        window.location.href = "../../";
      }
    }
  </script>
</head>
<body onload="onload()">
  <div class="center">
    <div class="title_font">
      <font size="6">Validating login...</font>
    </div>
    <div class="normal_font">
      <font size="4">Please wait while we verify your session.</font>
    </div>
  </div>
</body>
</html>

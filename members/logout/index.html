<script>
  function getCookie(name) {
    return document.cookie.split(';').map(s=>s.trim()).find(x=>x.startsWith(name+'='))?.split('=')[1] || '';
  }

  setTimeout(async () => {
    const username = decodeURIComponent(getCookie("username"));
    const provider = (getCookie("provider") || "local").toLowerCase();
    const token = decodeURIComponent(getCookie("sessiontoken") || "");

    console.log("Logout: sending", { username, provider, token });

    try {
      const res = await fetch("https://dominic.eu5.org/TSAS/logout/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, provider, token })
      });
      const data = await res.json();
      console.log("Logout response:", data);
    } catch (e) {
      console.error("Logout fetch failed:", e);
    } finally {
      // Clear client cookies regardless
      const clear = name => document.cookie = `${name}=; max-age=0; SameSite=None; Secure; path=/`;
      ["username","picture","usingotheroptions","usingmicrosoftaccount","iniframe","inapp","provider","sessiontoken"].forEach(clear);
      // Redirect home
      location.href = "../../";
    }
  }, 300);
</script>

<script>
  function getCookie(name) {
    return document.cookie.split(';').map(s=>s.trim()).find(x=>x.startsWith(name+'='))?.split('=')[1] || '';
  }

  setTimeout(async () => {
    const username = decodeURIComponent(getCookie("username"));
    const provider = (getCookie("provider") || "local").toLowerCase();
    const token = decodeURIComponent(getCookie("token") || "");
    const socialtoken = decodeURIComponent(getCookie("socialtoken") || "");

    try {
      const res = await fetch("https://dominic.eu5.org/TSAS/logout/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, provider, token, socialtoken })
      });
      const data = await res.json();
      console.log("Logout response:", data);
    } catch (e) {
      console.error("Logout fetch failed:", e);
    } finally {
      // Clear client cookies regardless
      const clear = name => document.cookie = `${name}=; max-age=0; SameSite=None; Secure; path=/`;
      ["username","picture","usingotheroptions","usingmicrosoftaccount","iniframe","inapp","provider","socialtoken","token"].forEach(clear);

      if (provider == 'microsoft') {
        location.href = "https://login.microsoftonline.com/common/oauth2/v2.0/logout?post_logout_redirect_uri=https://tsasofficial.github.io";
      } else {
        // Redirect home
        location.href = "../../";
      }
    }
  }, 300);
</script>
